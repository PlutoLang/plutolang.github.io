"use strict";(self.webpackChunkpluto=self.webpackChunkpluto||[]).push([[3490],{3952:(s,e,l)=>{l.r(e),l.d(e,{assets:()=>t,contentTitle:()=>i,default:()=>F,frontMatter:()=>r,metadata:()=>n,toc:()=>a});const n=JSON.parse('{"id":"Optimizations/String Preallocation","title":"String Preallocation","description":"String preallocation can be used in C functions to avoid a copy when data is allocated just for Lua, e.g.:","source":"@site/docs/Optimizations/String Preallocation.md","sourceDirName":"Optimizations","slug":"/Optimizations/String Preallocation","permalink":"/docs/Optimizations/String Preallocation","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Special Arithmetic","permalink":"/docs/Optimizations/Special Arithmetic"},"next":{"title":"Packages","permalink":"/docs/Packages"}}');var o=l(4848),c=l(8453);const r={},i=void 0,t={},a=[];function d(s){const e={code:"code",div:"div",p:"p",pre:"pre",span:"span",...(0,c.R)(),...s.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(e.p,{children:"String preallocation can be used in C functions to avoid a copy when data is allocated just for Lua, e.g.:"}),"\n",(0,o.jsxs)(e.pre,{className:"shiki monokai",style:{backgroundColor:"#272822",color:"#F8F8F2"},children:[(0,o.jsx)(e.div,{className:"language-id",children:"cpp"}),(0,o.jsx)(e.div,{className:"code-container",children:(0,o.jsxs)(e.code,{children:[(0,o.jsxs)(e.div,{className:"line",children:[(0,o.jsx)(e.span,{style:{color:"#66D9EF",fontStyle:"italic"},children:"auto"}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:" data "}),(0,o.jsx)(e.span,{style:{color:"#F92672"},children:"="}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:" "}),(0,o.jsx)(e.span,{style:{color:"#A6E22E"},children:"malloc"}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:"(size)"}),(0,o.jsx)(e.span,{style:{color:"#9F570F"},children:";"})]}),(0,o.jsxs)(e.div,{className:"line",children:[(0,o.jsx)(e.span,{style:{color:"#A6E22E"},children:"some_func"}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:"(data"}),(0,o.jsx)(e.span,{style:{color:"#9F570F"},children:","}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:" size)"}),(0,o.jsx)(e.span,{style:{color:"#9F570F"},children:";"})]}),(0,o.jsxs)(e.div,{className:"line",children:[(0,o.jsx)(e.span,{style:{color:"#A6E22E"},children:"lua_pushlstring"}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:"(L"}),(0,o.jsx)(e.span,{style:{color:"#9F570F"},children:","}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:" ("}),(0,o.jsx)(e.span,{style:{color:"#F92672"},children:"const"}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:" "}),(0,o.jsx)(e.span,{style:{color:"#66D9EF",fontStyle:"italic"},children:"char"}),(0,o.jsx)(e.span,{style:{color:"#F92672"},children:"*"}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:")data"}),(0,o.jsx)(e.span,{style:{color:"#9F570F"},children:","}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:" size)"}),(0,o.jsx)(e.span,{style:{color:"#9F570F"},children:";"})]}),(0,o.jsxs)(e.div,{className:"line",children:[(0,o.jsx)(e.span,{style:{color:"#A6E22E"},children:"free"}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:"(data)"}),(0,o.jsx)(e.span,{style:{color:"#9F570F"},children:";"})]})]})})]}),"\n",(0,o.jsxs)(e.p,{children:["This can be optimized by including ",(0,o.jsx)(e.code,{children:"lstring.h"})," and replacing the lines around the call:"]}),"\n",(0,o.jsxs)(e.pre,{className:"shiki monokai",style:{backgroundColor:"#272822",color:"#F8F8F2"},children:[(0,o.jsx)(e.div,{className:"language-id",children:"cpp"}),(0,o.jsx)(e.div,{className:"code-container",children:(0,o.jsxs)(e.code,{children:[(0,o.jsxs)(e.div,{className:"line",children:[(0,o.jsx)(e.span,{style:{color:"#66D9EF",fontStyle:"italic"},children:"char"}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:" shrtbuf[LUAI_MAXSHORTLEN]"}),(0,o.jsx)(e.span,{style:{color:"#9F570F"},children:";"})]}),(0,o.jsxs)(e.div,{className:"line",children:[(0,o.jsx)(e.span,{style:{color:"#66D9EF",fontStyle:"italic"},children:"auto"}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:" data "}),(0,o.jsx)(e.span,{style:{color:"#F92672"},children:"="}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:" "}),(0,o.jsx)(e.span,{style:{color:"#A6E22E"},children:"plutoS_prealloc"}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:"(L"}),(0,o.jsx)(e.span,{style:{color:"#9F570F"},children:","}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:" shrtbuf"}),(0,o.jsx)(e.span,{style:{color:"#9F570F"},children:","}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:" size)"}),(0,o.jsx)(e.span,{style:{color:"#9F570F"},children:";"})]}),(0,o.jsxs)(e.div,{className:"line",children:[(0,o.jsx)(e.span,{style:{color:"#A6E22E"},children:"some_func"}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:"(data"}),(0,o.jsx)(e.span,{style:{color:"#9F570F"},children:","}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:" size)"}),(0,o.jsx)(e.span,{style:{color:"#9F570F"},children:";"}),(0,o.jsx)(e.span,{style:{color:"#88846F"},children:" // same as before"})]}),(0,o.jsxs)(e.div,{className:"line",children:[(0,o.jsx)(e.span,{style:{color:"#A6E22E"},children:"plutoS_commit"}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:"(L"}),(0,o.jsx)(e.span,{style:{color:"#9F570F"},children:","}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:" data"}),(0,o.jsx)(e.span,{style:{color:"#9F570F"},children:","}),(0,o.jsx)(e.span,{style:{color:"#F8F8F2"},children:" size)"}),(0,o.jsx)(e.span,{style:{color:"#9F570F"},children:";"})]})]})})]}),"\n",(0,o.jsx)(e.p,{children:"This is something we use throughout many of our standard libraries (base64, crypto, etc.) for more performance."})]})}function F(s={}){const{wrapper:e}={...(0,c.R)(),...s.components};return e?(0,o.jsx)(e,{...s,children:(0,o.jsx)(d,{...s})}):d(s)}},8453:(s,e,l)=>{l.d(e,{R:()=>r,x:()=>i});var n=l(6540);const o={},c=n.createContext(o);function r(s){const e=n.useContext(c);return n.useMemo((function(){return"function"==typeof s?s(e):{...e,...s}}),[e,s])}function i(s){let e;return e=s.disableParentContext?"function"==typeof s.components?s.components(o):s.components||o:r(s.components),n.createElement(c.Provider,{value:e},s.children)}}}]);